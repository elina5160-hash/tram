# План разработки: Telegram-бот + веб-магазин (Next.js + SQLite)

## Цели
- Запустить минимально жизнеспособный интернет‑магазин с веб‑UI и Telegram‑ботом.
- Поддержать каталог товаров, категории, корзину, избранные, покупки и профиль.
- Начать с простого бэкенда и SQLite; сохранить возможность дальнейшего роста.

## Архитектура
- Клиент: Next.js (App Router), TypeScript.
- Бэкенд: Node.js (API‑роуты в Next.js или отдельный Express), SQLite через ORM (Prisma/Drizzle). Для MVP используем API‑роуты Next.js.
- Бот: Telegram Bot API (Telegraf), вебхуки (или long polling в dev).
- Хранение: SQLite (файл в репозитории, миграции ORM).
- Аутентификация: NextAuth (email/telegram), привязка Telegram user_id к профилю.
- Платежи: интеграция через провайдера (Telegram Payments или внешний провайдер), для MVP — заглушка оплаты и оформление заказа без реального списания.

## Модель данных (упрощённо)
- User: id, email, telegram_user_id, name, avatar_url, created_at.
- Category: id, name, slug, created_at.
- Product: id, category_id, title, slug, description, price, currency, stock, images[], created_at.
- Favorite: id, user_id, product_id, created_at.
- Cart: id, user_id, updated_at.
- CartItem: id, cart_id, product_id, qty, price_snapshot, created_at.
- Order: id, user_id, status (new/paid/cancelled), total, currency, created_at.
- OrderItem: id, order_id, product_id, qty, price_snapshot.
- Payment: id, order_id, provider, status, payload_json, created_at.

## API эндпоинты (MVP)
- Auth: `POST /api/auth/signin`, `POST /api/auth/signout`, `GET /api/auth/session`.
- Catalog: `GET /api/categories`, `GET /api/products`, `GET /api/products/:slug`.
- Favorites: `GET/POST/DELETE /api/favorites`.
- Cart: `GET /api/cart`, `POST /api/cart/items`, `PATCH /api/cart/items/:id`, `DELETE /api/cart/items/:id`.
- Orders: `POST /api/orders`, `GET /api/orders/:id`.
- Payments: `POST /api/payments/:orderId/intent` (MVP заглушка), `POST /api/payments/webhook`.

## Telegram‑бот (потоки)
- Команды: `/start`, каталог, поиск, корзина, избранные, заказ.
- Основной UX: быстрый просмотр позиций, добавление в корзину, переход в web‑app через deep link.
- Вебхуки: `/bot/webhook` (защищённый токен), развернуть на общем доступе.
- Хранение состояния: минимально — по user_id, корзина общая между ботом и веб.

## Веб‑приложение (страницы)
- `/` Главная: категории, популярные товары.
- `/category/[slug]` Список товаров.
- `/product/[slug]` Карточка товара, добавить в корзину/в избранные.
- `/cart` Корзина, оформление заказа.
- `/favorites` Избранные.
- `/profile` Профиль и заказы.

## 3.1. Публичная часть (интерфейс пользователя)
- 3.1.1. Главная страница с блоками: акционные товары, новинки, хиты продаж.
- 3.1.2. Каталог товаров с категориями. Карточка товара включает: фото, название, описание, состав, цену, рейтинг, отзывы, кнопку «Добавить в корзину».
- 3.1.3. Система рейтинга и отзывов к товарам.
- 3.1.4. Корзина покупок с функцией изменения количества и удаления товаров.
- 3.1.5. Функция рекомендаций («С этим товаром покупают») в корзине или на странице товара.
- 3.1.6. Информационный слайдер (баннер) на главной странице.
- 3.1.7. Кнопка «Поделиться» для генерации и отправки реферальной ссылки на конкретный товар.
- 3.1.8. Реферальная программа: поле для ввода промокода при оформлении заказа.
- 3.1.9. Опрос/квиз для определения потребностей клиента (одностраничная или многошаговая форма).
- 3.1.10. Нижнее меню навигации: Главная, Каталог, Корзина, Поддержка.
- 3.1.11. Боковое меню («гамбургер») с информационными разделами: Доставка, Оплата, Контакты, Отзывы, Возврат, О нас, Оферта, Помощь.
- 3.1.12. Раздел Поддержка: перенаправление пользователя в Telegram-чат с менеджером.

## 3.2. Административная часть (Панель Администратора)
- 3.2.1. Централизованная панель для управления контентом.
- 3.2.2. CRUD-функционал (Создание, Чтение, Редактирование, Удаление) для товаров: загрузка фото, редактирование названия, описания, состава, цены, категории.
- 3.2.3. Управление заказами: просмотр списка заказов, изменение их статуса.
- 3.2.4. Функция выгрузки списка заказов в файл формата .xlsx (Excel).
- 3.2.5. Настройка автоматической отправки уведомления о новом заказе в заданный Telegram-чат.

## Аутентификация
- NextAuth с провайдером Email (MVP). Добавить Telegram Login Widget позже.
- Связь аккаунта: при входе из бота — линковать `telegram_user_id`.

## Платежи
- Этап 1: заглушка — заказ создаётся, статус `new`.
- Этап 2: интеграция с провайдером (Telegram Payments или Stripe/YooKassa). Вебхуки обновляют `Payment` и `Order`.

## Тестирование
- Unit: сервисы корзины, избранных, расчёт totals.
- Интеграция: API‑роуты (в памяти/тестовая БД).
- E2E: критические флоу (Next.js + Playwright) — добавить позже.

## Безопасность
- Валидация входных данных (schema validation).
- Защита вебхуков (секреты, подписи).
- Rate‑limit на публичные API.
- Хранить секреты в env, не коммитить.

## Развёртывание
- Dev: локально, SQLite, long polling для бота.
- Prod: Vercel (Next.js) + Railway/Render (бот‑вебхуки) или единый Next.js на VPS.
- Домены/SSL: настроить для вебхуков.

## Пошаговый план (итерации)
1) Инициализация проекта: Next.js + TypeScript, настройка ORM, схема БД и миграции.
2) Каталог: категории и товары (CRUD в админке позже), публичные API и страницы.
3) Корзина и избранные: серверные роуты, клиентские компоненты.
4) Профиль и аутентификация: NextAuth, страница профиля, список заказов.
5) Заказ: создание Order, подсчёт totals, заглушка платежа.
6) Telegram‑бот: команды, каталог, добавление в корзину, deep link в веб.
7) Вебхуки платежей: базовая интеграция и обновление статусов.
8) Тюнинг UX/UI, деплой, минимальные метрики и логирование.

## Минимальные требования к окружению
- Node.js LTS, npm/pnpm.
- ENV: `DATABASE_URL` (sqlite), `NEXTAUTH_SECRET`, `TELEGRAM_BOT_TOKEN`, `WEBHOOK_SECRET`.

## Риски и дальнейшее развитие
- Рост данных: миграция на PostgreSQL/MySQL.
- Масштабирование бота: очереди, кеширование.
- Админ‑панель: управление товарами/заказами.
